<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>visu</title>
	<meta name="author" content="Nicolas ThiÃ©baud">
	<script type="text/javascript" src="/jquery-1.7.min.js"></script>
	<script type="text/javascript" src="/js/d3.js"></script>
	<script type="text/javascript" src="/js/d3.layout.js"></script>
	<script type="text/javascript" src="/js/d3.geom.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<style type="text/css" media="screen">
    line.link {
      stroke: #999;
      stroke-opacity: .6;
    }
  </style>
	<script type="text/javascript" charset="utf-8">

    $(function(){
      var w = 960,
        h = 500,
        fill = d3.scale.category20();
      var vis = d3.select("#chart").append("svg:svg")
        .attr("width", w)
        .attr("height", h);
        console.log(vis);
      
      var force = d3.layout.force()
        .charge(-120)
        .linkDistance(30)
        //.nodes(data.nodes)
        //.links(data.links)
        .size([w, h]).start();
          
      var socket = io.connect();
      socket.on('data', function(data){
        force.nodes(data.nodes).links(data.links).start();
        var link = vis.selectAll("line.link")
            .data(data.links)
          .enter().append("svg:line")
            .attr("class", "link")
            .style("stroke-width", function(d) { return d.value; });
        var node = vis.selectAll("circle.node")
            .data(data.nodes)
          .enter().append("svg:circle")
            .attr("class", "node")
            .attr("r", function(d) { return d.value; })
            .style("fill", function(d) { return fill(d.group); })
            .call(force.drag);

        node.append("svg:title")
            .text(function(d) { return d.name; });
            force.on("tick", function() {
              link.attr("x1", function(d) { return d.source.x; })
                  .attr("y1", function(d) { return d.source.y; })
                  .attr("x2", function(d) { return d.target.x; })
                  .attr("y2", function(d) { return d.target.y; });

              node.attr("cx", function(d) { return d.x; })
                  .attr("cy", function(d) { return d.y; });
            });
        socket.on('refresh data', function(data){
              var oldies = force.nodes();
              for(var i in oldies){
                data.nodes[i].x = oldies[i].x;
                data.nodes[i].y = oldies[i].y;
              }
              force.nodes(data.nodes).links(data.links).start();
                  link.data(data.links)
                    .attr("class", "link")
                    .style("stroke-width", function(d) { return Math.sqrt(d.value); });
                  node.data(data.nodes)
                    .attr("r", function(d) { return d.value; });
              node.append("svg:title")
                  .text(function(d) { return d.name; });
            })
      })
      
      socket.on('last tweet', function(t){
        $("#lasttweet").text(t);
      })
      
    })
    
	</script>
	<!-- Date: 2011-11-05 -->
</head>
<body>
  <div id="chart"></div>
  <p><b>Dernier tweet</b><br/><span id='lasttweet'></span></p>
</body>
</html>
